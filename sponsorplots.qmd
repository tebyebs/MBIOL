---
title: "Load and Check Ribits"
date: "`r Sys.Date()`"
format: 
  html:
    toc: true
    toc-depth: 4
    code-fold: true
    code-tools: true
editor: source
---


# Document Setup

## Load Packages 

you may not need all of these

```{r}
#| label: setup
#| echo: true
#| message: false
#| warning: false

# Load required packages
library(sf)                    # Spatial data handling
library(dplyr)                 # Data manipulation
library(janitor)               # Data cleaning
library(purrr)                 # Functional programming
library(ggplot2)               # Data visualization
library(lubridate)             # Date and time manipulation
library(here)                  # File path handling
library(tidyr)                 # Data tidying
library(knitr)                 # Document knitting
library(kableExtra)            # Table styling
library(glue)                  # String interpolation
library(rlang)                 # working with base R
library(stringr)               # pattern matching
library(gt)                    # Table styling
library(rnaturalearth)         # Map data
library(rnaturalearthdata)     # Map data
library(rnaturalearthhires)    # Map data
library(tidytext)              # Text processing
library(readxl)
```


## Load Data Example

I use the here package to specify in my own file folder - you will need to change this

```{r}
#| label: load-data
#| echo: true

# Load data
ribits_data_simplified <- read_excel("ribits_data_simplified.xlsx")

View(ribits_data_simplified)

# Load in the geopackage data
gpkg_file <- here("ribits_data", "bank_geometries.gpkg")

if (file.exists(gpkg_file)) {
  # Load all layers
  centroids <- st_read(gpkg_file, layer = "bank_centroids", quiet = TRUE) # reads in centroid layer
  footprints <- st_read(gpkg_file, layer = "bank_footprints", quiet = TRUE) # footprints
  service_areas <- st_read(gpkg_file, layer = "bank_service_areas", quiet = TRUE) # service areas
  service_areas_individual <- st_read(gpkg_file, layer = "bank_service_areas_individual", quiet = TRUE) # individual service areas (for banks with primary and secondary)
} else {
  stop("GeoPackage file not found!")
}
```


## Clean up data

its helpful to standardize the column names a bit - I use janitor package to clean up the names

```{r}
#| label: clean-data
#| echo: true

# Clean up the data - already done 
#ribits_data_simplified <- ribits_data_simplified %>% 
#  janitor::clean_names()

# Clean up the geometry data
centroids <- janitor::clean_names(centroids)
footprints <- janitor::clean_names(footprints)
service_areas <- janitor::clean_names(service_areas)
service_areas_individual <- janitor::clean_names(service_areas_individual)
```

## Create Analysis Dataframes

Only doing this bit as if you try and load the coordinates for the centroids, footprints, and service areas, it will crash your R session due to memory constraints.

```{r}
#| label: create-analysis-dataframes
#| echo: true

# To avoid memory issues, I separate out the geometries from the main table.
# Extract and rename geometry from each layer
centroids_geom <- centroids %>% 
  select(bank_id) %>% 
  rename(centroid = geom)


# Join them together into a single spatial dataframe
# We start with all bank IDs from the main table to ensure all banks are included
banks_geometries <- ribits_data_simplified %>%
  select(bank_id) %>%
  left_join(centroids_geom, by = "bank_id")



# Then, create a fast, non-spatial main dataframe with availability flags
# This adds boolean flags to the main data, which is much faster and more


# Clean up intermediate objects to save memory
rm(centroids_geom, footprints_geom, service_areas_geom)

# Remove the individual spatial dataframes since they are in a combined one
rm(centroids, footprints, service_areas, service_areas_individual)
```


# join ribits simplified with geom data into one database


```{r}
#| label: join-bank-sponsors
#| echo: true
merged_bank_summary <- readRDS(here("ribits_data", "merged_bank_summary.rds"))
# Join with geom data
ribits_w_geom <- ribits_data_simplified %>%
  left_join(banks_geometries, by = "bank_id") 

#add establishment year
ribits_w_geom <- ribits_w_geom %>%
  left_join(
    merged_bank_summary %>%
      select(bank_id, year_established),
    by = "bank_id"
  )
head(ribits_w_geom)

min(ribits_w_geom[,39], na.rm=T)
max(ribits_w_geom[,39], na.rm=T)




```


# Plot the bank centroids example

```{r}
#| label: bank-national-distribution-map
#| echo: true
#| fig-cap: "Distribution of RIBITS bank centroids across the United States."
#| fig-width: 10
#| fig-height: 6

# Prepare the centroid data for plotting
# We need a clean sf object with a valid CRS.


# Create a valid sf object from the centroid data for only public
public_centroids_sf <- ribits_w_geom %>% 
  # Keep only banks with a centroid geometry
  filter(!sapply(centroid, function(x) is.null(x) || st_is_empty(x))) %>%
  # Keep only public banks
  filter(is_public %in% TRUE) %>%
  # Convert to a proper sf object
  st_as_sf(sf_column_name = "centroid", crs = 4326) # Assume WGS84

dedup_publics <- distinct(public_centroids_sf, bank_id, .keep_all = T)
cat("Prepared", nrow(public_centroids_sf), "centroids for plotting.\n")

# Create a valid sf object from the centroid data for only nonprofit
nonprofit_centroids_sf <- ribits_w_geom %>% 
  # Keep only banks with a centroid geometry
  filter(!sapply(centroid, function(x) is.null(x) || st_is_empty(x))) %>%
  # Keep only public banks
  filter(is_nonprofit %in% TRUE) %>%
  # Convert to a proper sf object
  st_as_sf(sf_column_name = "centroid", crs = 4326) # Assume WGS84

dedup_nonprofits <- distinct(nonprofit_centroids_sf, bank_id, .keep_all = T)
cat("Prepared", nrow(nonprofit_centroids_sf), "centroids for plotting.\n")

# yearly maps - start from 1980, this is earliest
yearly_sf <- ribits_w_geom %>% 
  # Keep only banks with a centroid geometry
  filter(!sapply(centroid, function(x) is.null(x) || st_is_empty(x))) %>%
  # Keep only banks in year
  filter(year_established == 1980) %>%
  # Convert to a proper sf object
  st_as_sf(sf_column_name = "centroid", crs = 4326) # Assume WGS84
cat("Prepared", nrow(nonprofit_centroids_sf), "centroids for plotting.\n")

# 2. Get base map data using rnaturalearth to get country and state boundaries.
world <- ne_countries(scale = "medium", returnclass = "sf")
states <- ne_states(country = "United States of America", returnclass = "sf")
#this only has to be done once 


# 3. Create the map
ggplot() +
  # Add a base layer for the world, filled with a light grey
  geom_sf(data = world, fill = "gray90", color = "white") +
  # Add US state boundaries
  geom_sf(data = states, fill = "gray80", color = "white") +
  # Add the bank centroids on top
  geom_sf(
    data = top70pe,  #change depending on use 
    color = "red",
    size = 1.5,
    alpha = 0.4,
    shape = 16
  ) +
  # Set the coordinate system and limits.
  # This zooms the map to show the continental US, Alaska, Hawaii, and the Caribbean.
  coord_sf(
    xlim = c(-180, -65),
    ylim = c(18, 72),
    expand = FALSE,
    crs = 4326 # Use WGS84 projection
  ) +
  # Use a minimal theme suitable for maps
  theme_minimal() +
  theme(
    panel.background = element_rect(fill = "aliceblue"),
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12)
  )
```


```{r}
# yearly maps - start from 1980, this is earliest
yearly_sf <- ribits_w_geom %>% 
  # Keep only banks with a centroid geometry
  filter(!sapply(centroid, function(x) is.null(x) || st_is_empty(x))) %>%
  # Keep only banks in year
  filter( between(year_established, 2020,2025)) %>%
  # Convert to a proper sf object
  st_as_sf(sf_column_name = "centroid", crs = 4326) # Assume WGS84
cat("Prepared", nrow(yearly_sf), "centroids for plotting.\n")


# 3. Create the map
ggplot() +
  # Add a base layer for the world, filled with a light grey
  geom_sf(data = world, fill = "gray90", color = "white") +
  # Add US state boundaries
  geom_sf(data = states, fill = "gray80", color = "white") +
  # Add the bank centroids on top
  geom_sf(
    data = yearly_sf,  #change depending on use 
    color = "red",
    size = 1.5,
    alpha = 0.4,
    shape = 16
  ) +
  # Set the coordinate system and limits.
  # This zooms the map to show the continental US, Alaska, Hawaii, and the Caribbean.
  coord_sf(
    xlim = c(-180, -65),
    ylim = c(18, 72),
    expand = FALSE,
    crs = 4326 # Use WGS84 projection
  ) +
  # Use a minimal theme suitable for maps
  theme_minimal() +
  theme(
    panel.background = element_rect(fill = "aliceblue"),
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 12)
  )
```

